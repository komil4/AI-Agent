# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞

## üîç –ü—Ä–æ–±–ª–µ–º–∞
–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É (`/`), –Ω–æ —Å—Ä–∞–∑—É –∂–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ª–æ–≥–∏–Ω–∞ (`/login`).

## üéØ –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã

### 1. **Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞)**
- **–°–∏–º–ø—Ç–æ–º**: `‚ö†Ô∏è Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ`
- **–ü—Ä–æ–±–ª–µ–º–∞**: –°–µ—Å—Å–∏–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ –∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
- **–†–µ—à–µ–Ω–∏–µ**: –ó–∞–ø—É—Å—Ç–∏—Ç—å Redis –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–∞–π–ª–æ–≤–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ

### 2. **–ü—Ä–æ–±–ª–µ–º—ã —Å cookies**
- **–°–∏–º–ø—Ç–æ–º**: Cookie `session_id` –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∏–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ë—Ä–∞—É–∑–µ—Ä –±–ª–æ–∫–∏—Ä—É–µ—Ç cookies –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- **–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ cookies

### 3. **–ü—Ä–æ–±–ª–µ–º—ã —Å JWT —Ç–æ–∫–µ–Ω–∞–º–∏**
- **–°–∏–º–ø—Ç–æ–º**: JWT —Ç–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∏–ª–∏ –∏—Å—Ç–µ–∫
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤
- **–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ JWT

## üõ†Ô∏è –†–µ—à–µ–Ω–∏—è

### **–†–µ—à–µ–Ω–∏–µ 1: –ó–∞–ø—É—Å—Ç–∏—Ç—å Redis (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ)**

#### **–í–∞—Ä–∏–∞–Ω—Ç A: –ß–µ—Ä–µ–∑ Docker Compose**
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ Redis
docker-compose up redis -d

# –ò–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
docker-compose up -d
```

#### **–í–∞—Ä–∏–∞–Ω—Ç B: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Redis –ª–æ–∫–∞–ª—å–Ω–æ**
```bash
# Windows (—á–µ—Ä–µ–∑ Chocolatey)
choco install redis-64

# –ò–ª–∏ —Å–∫–∞—á–∞—Ç—å —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–∞–π—Ç–∞
# https://github.com/microsoftarchive/redis/releases
```

#### **–í–∞—Ä–∏–∞–Ω—Ç C: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Docker**
```bash
docker run -d --name redis -p 6379:6379 redis:alpine
```

### **–†–µ—à–µ–Ω–∏–µ 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–∞–π–ª–æ–≤–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–µ—Å—Å–∏–π**

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `auth/file_session_manager.py`:

```python
import json
import os
from datetime import datetime, timedelta
from typing import Optional, Dict, Any
import logging

logger = logging.getLogger(__name__)

class FileSessionManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä —Å–µ—Å—Å–∏–π —Å —Ñ–∞–π–ª–æ–≤—ã–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º"""
    
    def __init__(self, sessions_dir: str = "sessions"):
        self.sessions_dir = sessions_dir
        self.session_expire_hours = 24
        
        # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Å–µ—Å—Å–∏–π
        os.makedirs(sessions_dir, exist_ok=True)
    
    def create_session(self, user_info: Dict[str, Any], access_token: str) -> str:
        """–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é"""
        import uuid
        session_id = str(uuid.uuid4())
        
        session_data = {
            'user_info': user_info,
            'access_token': access_token,
            'created_at': datetime.utcnow().isoformat(),
            'last_activity': datetime.utcnow().isoformat()
        }
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
        session_file = os.path.join(self.sessions_dir, f"{session_id}.json")
        with open(session_file, 'w', encoding='utf-8') as f:
            json.dump(session_data, f, ensure_ascii=False, indent=2)
        
        logger.info(f"‚úÖ –°–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞ –≤ —Ñ–∞–π–ª–µ: {session_id}")
        return session_id
    
    def get_session(self, session_id: str) -> Optional[Dict[str, Any]]:
        """–ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏"""
        session_file = os.path.join(self.sessions_dir, f"{session_id}.json")
        
        if not os.path.exists(session_file):
            return None
        
        try:
            with open(session_file, 'r', encoding='utf-8') as f:
                session_data = json.load(f)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏—Å—Ç–µ–∫–ª–∞ –ª–∏ —Å–µ—Å—Å–∏—è
            created_at = datetime.fromisoformat(session_data['created_at'])
            if datetime.utcnow() - created_at > timedelta(hours=self.session_expire_hours):
                self.delete_session(session_id)
                return None
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
            session_data['last_activity'] = datetime.utcnow().isoformat()
            with open(session_file, 'w', encoding='utf-8') as f:
                json.dump(session_data, f, ensure_ascii=False, indent=2)
            
            return session_data
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ {session_id}: {e}")
            return None
    
    def delete_session(self, session_id: str):
        """–£–¥–∞–ª—è–µ—Ç —Å–µ—Å—Å–∏—é"""
        session_file = os.path.join(self.sessions_dir, f"{session_id}.json")
        if os.path.exists(session_file):
            os.remove(session_file)
            logger.info(f"üóëÔ∏è –°–µ—Å—Å–∏—è —É–¥–∞–ª–µ–Ω–∞: {session_id}")
```

### **–†–µ—à–µ–Ω–∏–µ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ cookies**

–í `app.py` —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ cookies —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ:

```python
json_response.set_cookie(
    key="session_id",
    value=session_id,
    httponly=True,
    secure=False,  # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ True –¥–ª—è HTTPS
    samesite="lax",  # –ü–æ–ø—Ä–æ–±—É–π—Ç–µ "none" –¥–ª—è cross-site
    max_age=24*60*60,
    path="/"  # –î–æ–±–∞–≤—å—Ç–µ —è–≤–Ω—ã–π –ø—É—Ç—å
)
```

### **–†–µ—à–µ–Ω–∏–µ 4: –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é**

–í–∫–ª—é—á–∏—Ç–µ DEBUG –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `app.py`:

```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

## üîß –ü–æ—à–∞–≥–æ–≤–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### **–®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å Redis**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∑–∞–ø—É—â–µ–Ω –ª–∏ Redis
redis-cli ping

# –ï—Å–ª–∏ Redis –Ω–µ –∑–∞–ø—É—â–µ–Ω, –∑–∞–ø—É—Å—Ç–∏—Ç—å –µ–≥–æ
docker-compose up redis -d
```

### **–®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –æ—Ç–ª–∞–¥–æ—á–Ω—ã–º–∏ –ª–æ–≥–∞–º–∏
python app.py

# –ò–ª–∏ —á–µ—Ä–µ–∑ uvicorn
uvicorn app:app --reload --log-level debug
```

### **–®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å cookies –≤ –±—Ä–∞—É–∑–µ—Ä–µ**
1. –û—Ç–∫—Ä–æ–π—Ç–µ Developer Tools (F12)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É Application/Storage
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Cookies –¥–ª—è –≤–∞—à–µ–≥–æ –¥–æ–º–µ–Ω–∞
4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `session_id` –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç

### **–®–∞–≥ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é**
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
python test_auth.py
```

## üöÄ –ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É:

1. **–ó–∞–ø—É—Å—Ç–∏—Ç—å Redis —á–µ—Ä–µ–∑ Docker:**
   ```bash
   docker run -d --name redis -p 6379:6379 redis:alpine
   ```

2. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:**
   ```bash
   python app.py
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä
   - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ `http://localhost:8000`
   - –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –ª–æ–≥–∏–Ω

## üìä –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–µ—Å—Å–∏–π:**
```python
from auth.session_manager import SessionManager
sm = SessionManager()
print(f"–°–µ—Å—Å–∏–π –≤ –ø–∞–º—è—Ç–∏: {len(sm._sessions)}")
```

### **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Redis:**
```python
import redis
r = redis.Redis(host='localhost', port=6379, db=0)
print(f"Redis –¥–æ—Å—Ç—É–ø–µ–Ω: {r.ping()}")
```

### **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å cookies:**
```javascript
// –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞
console.log(document.cookie);
```

## üéØ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ –õ–æ–≥–∏–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π
- ‚úÖ –°–µ—Å—Å–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º
- ‚úÖ –î–æ—Å—Ç—É–ø –∫ –∑–∞—â–∏—â–µ–Ω–Ω—ã–º —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º —Ä–∞–±–æ—Ç–∞–µ—Ç

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- **Redis**: https://redis.io/
- **Docker Compose**: https://docs.docker.com/compose/
- **FastAPI Cookies**: https://fastapi.tiangolo.com/tutorial/cookie-params/
- **Session Management**: https://fastapi.tiangolo.com/tutorial/security/
