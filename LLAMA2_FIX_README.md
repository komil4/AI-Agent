# Исправление проблемы с Llama2 и инструментами

## Проблема
Llama2 при работе с инструментами возвращает текстовые советы вместо JSON-ответов, что приводит к неправильной обработке запросов.

## Решение

### 1. Принудительное использование fallback для Llama2
- Добавлена проверка на модели с "llama2" или "llama" в названии
- Для таких моделей принудительно используется fallback логика

### 2. Улучшенные системные инструкции
- Более четкие инструкции для генерации JSON
- Примеры правильного формата ответов
- Строгие требования к формату

### 3. Улучшенный парсинг JSON
- Обработка markdown блоков (```json)
- Поиск JSON в тексте с помощью регулярных выражений
- Fallback на извлечение инструмента по ключевым словам

### 4. Дополнительная обработка в LLM клиенте
- Рекурсивная обработка извлеченного JSON
- Извлечение инструментов из текстовых ответов
- Сопоставление ключевых слов с инструментами

## Тестирование

Запустите тестовый скрипт:
```bash
python test_llama2_fix.py
```

## Конфигурация

Убедитесь, что в конфигурации Ollama настроен правильно:
```json
{
  "llm": {
    "provider": "ollama",
    "base_url": "http://localhost:11434",
    "model": "llama2:7b",
    "enabled": true
  }
}
```

## Отладка

Для отладки включены логи ответов Llama2. Они показывают первые 200 символов ответа для анализа.

## Поддерживаемые модели

- Llama2 (все версии)
- Llama (все версии)
- Другие модели без поддержки инструментов

## Ключевые слова для извлечения инструментов

- **Создание задач**: "создай задачу", "создать задачу", "новая задача"
- **Поиск задач**: "найди задачи", "поиск задач", "найти issue"
- **Список задач**: "покажи задачи", "список задач", "все задачи"
- **Обновление задач**: "обнови задачу", "изменить задачу"
- **Проекты**: "создай проект", "покажи проекты", "список проектов"
- **Merge requests**: "создай merge request", "новый merge request"
- **Коммиты**: "покажи коммиты", "список коммитов", "история коммитов"
