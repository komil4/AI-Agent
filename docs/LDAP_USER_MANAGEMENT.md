# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ LDAP –≤ MCP Chat

## –û–±–∑–æ—Ä

MCP Chat –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ LDAP –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö PostgreSQL –ø—Ä–∏ –∏—Ö –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ –≤ —Å–∏—Å—Ç–µ–º—É. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –º–µ–∂–¥—É Active Directory –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Å–∏—Å—Ç–µ–º–æ–π —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ LDAP –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å LDAP –≤–ø–µ—Ä–≤—ã–µ –≤—Ö–æ–¥–∏—Ç –≤ —Å–∏—Å—Ç–µ–º—É:

1. **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Active Directory** - –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
2. **–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ AD** - –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
   - `username` (sAMAccountName)
   - `display_name` (displayName)
   - `email` (mail)
   - `groups` (memberOf)
3. **–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –ë–î** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `users`
4. **–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏** - —Å–æ–∑–¥–∞–µ—Ç—Å—è JWT —Ç–æ–∫–µ–Ω –∏ —Å–µ—Å—Å–∏—è

### –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ

–ü—Ä–∏ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –≤—Ö–æ–¥–∞—Ö:

1. **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ AD** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
2. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö** - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ –ë–î
3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ last_login** - —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—Ö–æ–¥–∞

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –¢–∞–±–ª–∏—Ü–∞ `users`

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(100) UNIQUE NOT NULL,
    display_name VARCHAR(200),
    email VARCHAR(200),
    groups TEXT[],
    is_admin BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP
);
```

### –ú–∞–ø–ø–∏–Ω–≥ LDAP ‚Üí Database

| LDAP –∞—Ç—Ä–∏–±—É—Ç | Database –ø–æ–ª–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------------|---------------|----------|
| `sAMAccountName` | `username` | –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| `displayName` | `display_name` | –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è |
| `mail` | `email` | Email –∞–¥—Ä–µ—Å |
| `memberOf` | `groups` | –ú–∞—Å—Å–∏–≤ –≥—Ä—É–ø–ø AD |
| - | `is_admin` | –§–ª–∞–≥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é false) |
| - | `created_at` | –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ |
| - | `last_login` | –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—Ö–æ–¥–∞ |

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏ —á–∞—Ç–∞

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π

–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ —á–∞—Ç—É:

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏** - –∏—â–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. **–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏** - –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤–∞—è
3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π** - –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏–≤—è–∑—ã–≤–∞—é—Ç—Å—è –∫ —Å–µ—Å—Å–∏–∏

### –¢–∞–±–ª–∏—Ü–∞ `chat_sessions`

```sql
CREATE TABLE chat_sessions (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    session_name VARCHAR(200),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE
);
```

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```
‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ivanov (ID: 5)
   Display Name: –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á
   Email: ivanov@company.com
   Groups: ['CN=Developers,OU=Groups,DC=company,DC=com']
   Is Admin: False
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```
‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ivanov (ID: 5)
   –ò–∑–º–µ–Ω–µ–Ω–∏—è: display_name: '–ò–≤–∞–Ω–æ–≤ –ò.–ò.' -> '–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á', groups: [] -> ['CN=Developers,OU=Groups,DC=company,DC=com']
```

### –¢–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—Ö–æ–¥–∞

```
‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ivanov (ID: 5) - —Ç–æ–ª—å–∫–æ last_login
```

## API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

### –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ

```http
GET /api/user/profile
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "username": "ivanov",
  "display_name": "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á",
  "email": "ivanov@company.com",
  "groups": ["CN=Developers,OU=Groups,DC=company,DC=com"],
  "is_admin": false,
  "created_at": "2024-01-15T10:30:00",
  "last_login": "2024-01-15T14:20:00"
}
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```http
GET /api/chat/sessions
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "sessions": [
    {
      "id": 1,
      "name": "–°–µ—Å—Å–∏—è 2024-01-15 10:30",
      "created_at": "2024-01-15T10:30:00",
      "updated_at": "2024-01-15T11:45:00",
      "is_active": true
    }
  ]
}
```

## –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ pgAdmin

```sql
SELECT 
    id,
    username,
    display_name,
    email,
    groups,
    is_admin,
    created_at,
    last_login
FROM users 
ORDER BY created_at DESC;
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

```sql
SELECT 
    username,
    display_name,
    COUNT(DISTINCT s.id) as sessions_count,
    COUNT(m.id) as messages_count,
    MAX(m.created_at) as last_activity,
    last_login
FROM users u
LEFT JOIN chat_sessions s ON u.id = s.user_id
LEFT JOIN messages m ON s.id = m.session_id
GROUP BY u.id, u.username, u.display_name, u.last_login
ORDER BY last_activity DESC;
```

### –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –≥—Ä—É–ø–ø–∞–º

```sql
SELECT username, display_name, groups
FROM users 
WHERE 'Developers' = ANY(groups);
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≥—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è:

- –î–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º
- –î–æ—Å—Ç—É–ø–∞ –∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º MCP —Å–µ—Ä–≤–µ—Ä–∞–º
- –î–æ—Å—Ç—É–ø–∞ –∫ API —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º

### –ü—Ä–∏–º–µ—Ä –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥—Ä—É–ø–ø

```python
# –í –∫–æ–¥–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
user_groups = user_info.get('groups', [])
if any('Admin' in group for group in user_groups):
    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    pass
```

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ –ë–î

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:**
   ```
   üîç –°–æ–∑–¥–∞–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è LDAP –≤ –ë–î: username
   ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å LDAP —Å–æ–∑–¥–∞–Ω/–æ–±–Ω–æ–≤–ª–µ–Ω –≤ –ë–î: 123
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î:**
   ```bash
   docker exec postgres-server pg_isready -U mcp_user -d mcp_chat
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—É users:**
   ```sql
   SELECT * FROM users WHERE username = 'problematic_user';
   ```

### –°–µ—Å—Å–∏–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–∫—Ç–∏–≤–Ω—É—é —Å–µ—Å—Å–∏—é:**
   ```sql
   SELECT * FROM chat_sessions WHERE user_id = 123 AND is_active = true;
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —á–∞—Ç–∞:**
   ```
   ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Å–µ—Å—Å–∏—è: 456
   –∏–ª–∏
   ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è: 456
   ```

### –ü—Ä–æ–±–ª–µ–º—ã —Å –≥—Ä—É–ø–ø–∞–º–∏ LDAP

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –≥—Ä—É–ø–ø –≤ –ë–î:**
   ```sql
   SELECT username, groups FROM users WHERE username = 'test_user';
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ AD –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:**
   ```
   Groups: ['CN=Developers,OU=Groups,DC=company,DC=com']
   ```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏

```sql
SELECT 
    username,
    display_name,
    last_login,
    COUNT(DISTINCT s.id) as active_sessions
FROM users u
LEFT JOIN chat_sessions s ON u.id = s.user_id AND s.is_active = true
WHERE last_login > NOW() - INTERVAL '24 hours'
GROUP BY u.id, u.username, u.display_name, u.last_login
ORDER BY last_login DESC;
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—Ö–æ–¥–æ–≤

```sql
SELECT 
    DATE(last_login) as login_date,
    COUNT(*) as unique_users
FROM users 
WHERE last_login IS NOT NULL
GROUP BY DATE(last_login)
ORDER BY login_date DESC;
```
